<!-- prettier-ignore -->

{% extends "base_page.html" %}

{% block title %}ChallengeMe | {{ challenge_name }}{% endblock %}

{% block page_css %}
<style>
  .record-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
    padding: 20px 0;
  }

  .record-item {
    aspect-ratio: 1;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
  }

  .record-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  }

  .record-item.no-photo {
    background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    font-size: 14px;
    text-align: center;
    padding: 20px;
  }

  .record-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .record-item.has-photo {
    position: relative;
  }

  .record-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
    color: white;
    padding: 12px 8px 8px;
    font-size: 12px;
    font-weight: 500;
    text-align: center;
  }

  .challenge-info {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    margin-bottom: 24px;
  }

  .records-section {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  }

  .section-title {
    font-size: 20px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .record-count {
    background: #3b82f6;
    color: white;
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 14px;
    font-weight: 500;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6b7280;
  }

  .empty-state svg {
    width: 64px;
    height: 64px;
    margin: 0 auto 16px;
    opacity: 0.5;
  }

  .main-content {
    margin-top: 80px;
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
    padding: 0 20px;
  }

  .record-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    background-color: rgba(59, 130, 246, 0.9); /* Tailwind의 blue-500 */
    color: white;
    padding: 4px 8px;
    font-size: 12px;
    font-weight: 600;
    border-radius: 8px;
    z-index: 2;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
  }
</style>
<!-- prettier-ignore -->

{% endblock %}

{% block header %}
{% include 'navigation_bar.html' %}
{% endblock %}

{% block main %}
<div class="main-content">
  <!-- 챌린지 정보 섹션 -->
  <div class="challenge-info">
    <div class="challenge-details">
      <h1 class="text-3xl font-bold text-gray-800 mb-4">{{ challenge_name }}</h1>
      <div class="flex items-center gap-4 text-sm text-gray-600">
        <span class="font-medium">시작:</span>
        <span>{{ start_date }}</span>
        <span class="font-medium">종료:</span>
        <span>{{ end_date }}</span>
      </div>
    </div>
  </div>

  <div class="flex gap-6 justify-center mb-6">
    <!-- 인증 내역 섹션 -->
    <div class="records-section">
      <div class="section-title">
        # 인증 내역
        <span class="record-count" id="record-count">0</span>
      </div>

      <!-- 레코드 그리드 -->
      <div id="records-container">
        <div class="record-grid" id="records-grid">
          <!-- 레코드들이 여기에 동적으로 추가됩니다 -->
        </div>
      </div>

      <!-- 빈 상태 표시 -->
      <div class="empty-state" id="empty-state" style="display: none">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
          ></path>
        </svg>
        <p class="text-lg font-medium mb-2">아직 인증된 기록이 없습니다</p>
        <p class="text-sm">첫 번째 인증을 시작해보세요!</p>
      </div>
    </div>
  </div>
  {% endblock %} {% block page_js %}
  <script>
    let currentChallengeId = '{{ challenge_id }}';
    let recordsData = [
      {
        _id: '686e6bf8271d71d652ccdc07',
        challenge_id: '686e6307d14d8de2cf38574d',
        created_date: '0701',
        oneline_diary: '바',
        photo_url: 'https://i.pinimg.com/736x/f8/0d/03/f80d03c745e2138d36d1af6a07be8b93.jpg',
      },
    ];
    function loadRecords() {
      $.ajax({
        type: 'GET',
        url: '/api/record',
        data: { challenge_id: currentChallengeId },
        success: function (response) {
          if (response.success) {
            console.log('하이루');
            recordsData = response.data;
            renderRecords();
          } else {
            console.error('레코드 조회 실패:', response.error);
            showEmptyState();
          }
        },
        error: function (xhr, status, error) {
          console.error('API 요청 실패:', error);
          showEmptyState();
        },
      });
    }
    renderRecords();

    function renderRecords() {
      const recordsGrid = $('#records-grid');
      const recordCount = $('#record-count');
      const emptyState = $('#empty-state');

      if (!recordsData || recordsData.length === 0) {
        showEmptyState();
        return;
      }

      // 빈 상태 숨기기
      emptyState.hide();
      recordsGrid.show();

      // 레코드 개수 업데이트
      recordCount.text(recordsData.length);

      // 그리드 초기화
      recordsGrid.empty();

      // 각 레코드에 대해 아이템 생성
      recordsData.forEach(function (record) {
        const recordItem = createRecordItem(record);
        recordsGrid.append(recordItem);
      });
    }

    function createRecordItem(record) {
      const recordId = record._id;
      const photoUrl = record.photo_url;
      const createdDateRaw = record.created_date;
      const createdDate = formatKoreanDate(createdDateRaw);

      let itemHtml;

      if (photoUrl) {
        // 사진이 있는 경우
        itemHtml = `
                <div class="record-item has-photo" data-record-id="${recordId}" title="인증일: ${createdDate}">
                  <img src="${photoUrl}" alt="인증 사진 (${createdDate})" onerror="handleImageError(this)">
                  <div class="record-badge">${createdDate}</div>
                </div>
              `;
      } else {
        // 사진이 없는 경우
        itemHtml = `
                <div class="record-item has-photo" data-record-id="${recordId}" title="인증일: ${createdDate}">
                  <div class="text-sm font-medium mb-1">사진 없음</div>
                  <div class="record-badge">${createdDate}</div>
              </div>
            `;
      }

      return $(itemHtml);
    }

    function handleImageError(img) {
      // 이미지 로드 실패 시 처리
      const parent = $(img).parent();
      const recordId = parent.data('record-id');
      const createdDate = parent.attr('title').replace('인증일: ', '');

      parent.removeClass('record-item has-photo').addClass('record-item no-photo');
      parent.html(`
                <div>
                    <div class="text-sm font-medium mb-1">이미지 로드 실패</div>
                    <div class="text-xs">${createdDate}</div>
                </div>
            `);
    }

    function showEmptyState() {
      $('#records-grid').hide();
      $('#empty-state').show();
      $('#record-count').text('0');
    }

    function onRecordClick(recordId) {
      // 레코드 클릭 시 상세 보기나 다른 액션 수행
      console.log('레코드 클릭:', recordId);
      // 필요에 따라 모달 열기나 다른 페이지로 이동 등의 액션 추가
    }
    // datetime.datetime(2025, 7, 9, 21, 39, 35, 193000)
    $(document).ready(function () {
      // 페이지 로드 시 레코드 조회
      loadRecords();

      // 레코드 클릭 이벤트 (동적으로 추가되는 요소에 대한 이벤트 위임)
      $(document).on('click', '.record-item', function () {
        const recordId = $(this).data('record-id');
        onRecordClick(recordId);
      });
    });

    function formatKoreanDate(mmdd) {
      if (!mmdd || mmdd.length !== 4) return mmdd;

      const month = parseInt(mmdd.slice(0, 2), 10);
      const day = parseInt(mmdd.slice(2, 4), 10);

      return `${month}월 ${day}일`;
    }
  </script>
  <!-- prettier-ignore -->

  {% endblock %}

{% block add_ready_js %}
  <!-- // 추가 초기화 코드가 필요한 경우 여기에 작성 -->
  {% endblock %}
</div>
